---
description: Python backend conventions for Litestar API
globs: ["automation-backend/**/*.py"]
---

# Python Backend Conventions

## Data Structures
- Use `msgspec.Struct` for all data models (NOT Pydantic, dataclasses)
- Example:
  ```python
  import msgspec
  
  class Recipe(msgspec.Struct):
      id: int
      name: str
      ingredients: list[str]
  ```

## DataFrames
- Use `polars` for any DataFrame operations (NOT pandas)
- Import as: `import polars as pl`

## Package Management
- Use `uv` with `pyproject.toml`
- Add dependencies via: `uv add <package>`
- Never make up version numbers

## Code Quality
- Use `complexipy` to keep cognitive complexity low
- Prefer simplifying abstractions over refactoring into more methods
- Pre-commit hooks enforce: ruff, pylint, complexipy
- Fix warnings, not just errors

## Async Patterns
- Litestar handlers are async by default
- Use `psycopg` async connection pool from `db/pool.py`
- Pattern for DB queries:
  ```python
  async with pool.connection() as conn:
      result = await conn.execute(query, params)
  ```

## API Layer (`api/`)
- Route handlers in separate files by domain
- Use Litestar dependency injection
- Return msgspec.Struct instances directly

## Type Hints
- All functions must have complete type hints
- Use `| None` syntax (not Optional)
- Python 3.12+ features allowed

## Testing
- Tests in `tests/` directory
- Use pytest with pytest-asyncio
- Test files: `test_*.py`

## Backwards Compatibility
- Do NOT write backwards compatibility code unless explicitly asked
- Write for the current state
